<app-dashboard></app-dashboard>

<div class="dashboard-main">
  <div class="container-fluid">
    <div class="table-responsive">
      <div class="table-wrapper">
        <div class="table-title">
          <div class="row " style="height: 60px;">
            <div class="col-sm-5 ">
              <h2 style="margin-bottom: 0;">Quản lý đơn đặt hàng</h2>
            </div>
            <div class="col-sm-7 text-end d-flex align-items-center justify-content-end">
              <a routerLink="/order_rq" class="btn btn-secondary btn-sm" data-toggle="modal" data-target=""
                style="font-size: 14px;">
                <i class="material-icons align-middle" style="font-size: 18px;">&#xE147;</i>
                <span class="align-middle">Thêm đơn hàng</span>
              </a>
            </div>
          </div>

          <div class="row  justify-content-end">
            <div class="col-md-9 text-end">
              <div class="input-group mb-3">
                <!-- product.component.html -->
                <label>Từ: </label>
                <input [(ngModel)]="selectedSDate" style="margin-left: 10px;" type="date" class="form-control"
                  placeholder="Đến: dd/mm/yyyy">

                <label>Đến: </label>
                <input [(ngModel)]="selectedEDate" style="margin-left: 10px;" type="date" class="form-control"
                  placeholder="Đến: dd/mm/yyyy">

                <!-- product.component.html -->
                <select [(ngModel)]="selectedCategory">
                  <!-- <option value="0" selected disabled>Chọn đơn hàng</option> -->
                  <option *ngFor="let ps of userStatus" [value]="ps.status_id">{{ ps.status_name }}</option>
                  <option value="" selected>Tất cả danh mục</option>
                </select>

                <input type="text" class="form-control" placeholder="Tìm kiếm mã đơn hàng..." [(ngModel)]="searchKey">

                <button class="btn search-button" type="button" (click)="filterStatus()">
                  <i class="fa fa-search"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>Mã đơn hàng</th>

                <th>Thao tác</th>

                <th>Loại đơn hàng</th>
                <th>Ngày đặt hàng</th>
                <th>Tình trạng</th>

                <th>Kiểu thanh toán</th>
                <th>Tiền cọc(VNĐ)</th>

                <th>Tổng tiền(VNĐ)</th>

              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let us of user | paginate: { itemsPerPage: 10, currentPage: currentPage }; let i = index">

                <td style=" min-width: 140px;">{{ us?.code}}</td>


                <td class="action-buttons">
                  <!-- <a href="#" class="settings" title="Edit" data-toggle="modal" data-target="#editProductModal">
                  <i class="fa-solid fa-pen-to-square"></i>
                </a> -->
                  <a href="#" class="info" title="Xem chi tiết" data-toggle="modal" data-target="#productDetailModal"
                    (click)="getOrDetailById(us, us?.orderId)">
                    <i class="fa-solid fa-circle-info"></i>
                  </a>
                  <a href="/product_management/{{ us?.orderId }}" class="info" title="Thêm sản phẩm" *ngIf="us?.status_id === 8 && 
                  us?.specialOrder === true">
                    <i class="fa-solid fa-circle-plus"></i>
                  </a>

                  <a href="#" data-toggle="modal" data-target="#myModalconfirm"
                    *ngIf="us?.status_id === 1 " (click)="setOrderForPayment(us?.orderId)"
                    (click)="getOrDetailById(us, us?.orderId)">
                    <i class="fa-solid fa-credit-card"></i>
                  </a>

                  <a href="#" data-toggle="modal" data-target="#confirmDeleteModal"
                    (click)="setOrderForCancellation(us?.orderId, us?.specialOrder)" *ngIf="us?.status_id === 7">
                    <i class="fa-solid fa-times-circle"></i>
                  </a>
                </td>

                <td style="min-width: 140px;">
                  {{ us?.specialOrder ? 'Đơn hàng đặc biệt' : 'Đơn hàng có sẵn' }}
                </td>
                <td style="text-align: center;">{{ us?.orderDate | date:'dd/MM/yyyy' }}</td>

                <!-- [disabled]="us?.status.status_id === 6 || us?.status.status_id === 5
              || us?.status.status_id === 1
              || us?.status.status_id === 3"  -->
                <td *ngIf="us?.totalAmount === null">
                  <div class="select-wrapper">
                    <select id="mySelect{{i}}" [disabled]="us?.status_id !== 4 && us?.status_id !== 7"
                      class="custom-select" (change)="openModal(us.orderId, $event, i)">
                      <option *ngFor="let status of status_order" [value]="status.status_id"
                        [selected]="status.status_id === us?.status_id" [disabled]="status.status_id !== 8"
                        [hidden]="status.status_id !== 7 && status.status_id !== 8">
                        {{ status.status_name }}
                      </option>
                    </select>
                    <button #launchModalButton type="button" class="btn btn-primary d-none" data-toggle="modal"
                      data-target="#myModal">
                      Launch modal
                    </button>
                  </div>
                </td>



                <td style="min-width: 200px;" *ngIf="us?.totalAmount !== null">
                  <div class="select-wrapper">
                    <select id="mySelect{{i}}" [disabled]="us?.status_id !== 4" class="custom-select"
                      (change)="openModal(us.orderId, $event, i)">
                      <option *ngFor="let status of status_order" [value]="status.status_id"
                        [selected]="status.status_id === us?.status_id" [disabled]="status.status_id !== 5"
                        [hidden]="status.status_id !== 4 && status.status_id !== 5">
                        {{ status.status_name }}
                      </option>
                    </select>
                    <button #launchModalButton type="button" class="btn btn-primary d-none" data-toggle="modal"
                      data-target="#myModal">
                      Launch modal
                    </button>
                  </div>
                </td>



                <td style=" min-width: 30px;"
                  [ngStyle]="{'color': us?.paymentMethod === 2 ? 'green' : (us?.paymentMethod === 1 ? 'red' : 'black')}">
                  {{ us?.paymentMethod === 2 ? 'Chuyển khoản' : (us?.paymentMethod === 1 ? 'Tiền mặt' : '') }}
                </td>

                <td
                  style="text-align: right; min-width: 100px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ us?.deposite | number : '1.0-3' }}
                </td>
                <!-- <td
                  style="text-align: right; min-width: 100px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ (us?.totalAmount - us?.deposite) | number : '1.0-3' }}
                </td> -->
                <td
                  style="text-align: right; min-width: 100px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ us?.totalAmount | number : '1.0-3' }}
                </td>

              </tr>
            </tbody>
          </table>
        </div>
      </div>


      <pagination-controls style="justify-content: right; display: flex;" (pageChange)="currentPage = $event"
        previousLabel="Trang trước" nextLabel="Trang sau" *ngIf="user && user.length > 0">
      </pagination-controls>
      <div class="clearfix" style="justify-content: right; display: flex;" *ngIf="user && user.length > 0">
        <div class="hint-text">Hiển thị <b>{{ (currentPage - 1) * 10 + 1 }}</b> tới <b>{{ currentPage * 10 >
            user.length ? user.length : currentPage * 10 }}</b> trong tổng <b>{{
            user.length }}</b> dữ liệu</div>
      </div>

      <div *ngIf="!user || user.length === 0">

        <div style="background-color: white;">
          <div class="" style="display: flex; justify-content: center; align-items: center; height: 100%;">
            <img
              src="https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcSG53pYn6cpXaiwT_q6IM45P-rXg5dUw67XqRmr9-vtsbMoHnCG"
              alt="" class="product-img" style="width: 150px; height: 150px; object-fit: cover;">
            <p class="name-product text-center">Không tìm thấy đơn hàng!</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" style="margin-left: 7%;" id="productDetailModal" tabindex="-1" role="dialog"
    aria-labelledby="productDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productDetailModalLabel">Xem chi tiết đơn hàng</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body" style="font-size: 16px;">
          <div class="container">
            <div class="row">
              <div class="col-md-4">
                <b>Đơn hàng: </b>

                <label style="color: rgba(0, 102, 255, 0.945);">{{OrderdetailById.code}}</label>
              </div>
              <div class="col-md-4 text-center"> <b>Ngày tạo đơn:</b> {{OrderdetailById.orderDate | date:'dd/MM/yyyy'}}
              </div>


              <div class="col-md-4 text-end">
                <b> {{OrderdetailById.status?.status_name}}</b>
              </div>
            </div>
            <br>
            <hr>
            <div class="row">
              <div class="col-md-4">
                <div class="card">
                  <div class="card-header text-center">
                    Khách hàng
                  </div>
                  <div class="card-body">
                    <h3 class="card-title">{{OrderdetailById.userInfor?.fullname}} -
                      {{OrderdetailById.userInfor?.phoneNumber}}</h3>

                    <p class="card-text">Địa chỉ: {{OrderdetailById.userInfor?.address}}</p>
                  </div>
                </div>
                <br>
                <hr>
                <br>
                <div class="card">
                  <div class="card-header text-center">
                    Thông tin đơn hàng
                  </div>
                  <div class="card-body">
                    <!-- <h5 class="card-title">{{OrderdetailById.userInfor?.fullname}}</h5> -->
                    <p class="card-text"><b>Đã cọc: </b>{{OrderdetailById.deposite | number : '1.0-3' }} vnđ</p>
                    <p class="card-text"><b>Thanh toán:</b>{{OrderdetailById.paymentMethod}}</p>
                    <p class="card-text"><b>Mô tả đơn hàng:</b> {{OrderdetailById.description}}</p>
                  </div>
                </div>
              </div>

              <div class="col-md-8">
                <h2 class="text-center">Thông tin đơn hàng</h2>
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th style="width: 40%;">Tên sản phẩm</th>
                      <th>Đơn giá</th>
                      <th>Trạng thái</th>
                      <th>Số lượng</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let product of productOfOrder">
                      <td>{{product?.product_name}} {{product?.request_product_name}}</td>
                      <td>{{product?.price | number:'1.0-3'}}</td>
                      <td>{{product?.status_job_name}}</td>
                      <td style="text-align: right;">{{product?.quantity}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
        </div>
      </div>
    </div>
  </div>




  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteModalLabel">Xác nhận muốn hủy đơn hàng</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="cancelReason">Lý do từ chối đơn hàng:</label>
            <textarea class="form-control" id="cancelReason" [(ngModel)]="cancelReason" rows="4" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" (click)="confirmCancel()">Xác nhận</button>
        </div>
      </div>
    </div>
  </div>




  <div class="modal fade" id="myModalconfirm" tabindex="-1" aria-labelledby="myModalLabel1" aria-hidden="true"
    data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="myModalconfirm">Xác nhận thanh toán cọc</h2>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close" (click)="closeModal($event) "
            (click)="cancelChangeStatusJob()"></button>
        </div>
        <div class="modal-body">
          <p>Tiền cọc: {{OrderdetailById.deposite | number : '1.0-3'}}</p>
          <p>Tiền cần thanh toán: {{ OrderdetailById.totalAmount - OrderdetailById.deposite | number : '1.0-3' }}</p>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="closeModal($event)"
            (click)="cancelChangeStatusJob()">Đóng</button>
          <button type="button" class="btn btn-primary" (click)="confirmPayment()">Chắc
            chắn
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="myModalLabel" aria-hidden="true"
    data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="myModal">Cập nhật trạng thái đơn hàng</h2>
          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"
            (click)="closeModal($event)"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn cập nhật trạng thái đơn hàng này?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="closeModal($event)"
            (click)="cancelChangeStatusJob()">Đóng</button>
          <button type="button" class="btn btn-primary" (click)="changeStatus(selectedModalJob,selectedModalId)">Chắc
            chắn</button>

        </div>
      </div>
    </div>
  </div>



  <!-- <div class="modal fade" id="myModalconfirm" tabindex="-1" aria-labelledby="myModalLabel1" aria-hidden="true"
          data-backdrop="static" data-keyboard="false">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h2 class="modal-title" id="myModalconfirm">Xác nhận thanh toán tiền cọc đơn hàng</h2>
                <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"
                  (click)="closeModal($event) " (click)="cancelChangeStatusJob()"></button>
              </div>
              <div class="modal-body">
                Bạn có chắc chắn xác nhận thanh toán tiền cọc đơn hàng này?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" (click)="closeModal($event)"
                  (click)="cancelChangeStatusJob()">Đóng</button>
                <button type="button" class="btn btn-primary" (click)="confirmPayment()">Chắc
                  chắn
                </button>
              </div>
            </div>
          </div>
        </div> -->


  <div *ngIf="isLoadding" class="loading-overlay">
    <div class="spinner"></div>
  </div>